<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>League of Legends Champions - Checklist</title>
    <style>
        :root{
            --bg:#0b0f19; --card:#121826; --text:#e6e8f0; --muted:#9aa4b2; --accent:#6ee7ff; --ring:#263043;
            --won:#22c55e; --place:#eab308; --sidebar:#0e1422;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

        .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}

        /* Title (non-sticky) */
        .titlebar{position:relative;}
        h1{font-size:clamp(20px,2.4vw,28px);margin:0 0 10px;font-weight:700}

        /* Sticky toolbar (+ fixed fallback via .fixed) */
        .toolbar-wrap{
            position:sticky; top:0; z-index:7;
            background:linear-gradient(180deg, rgba(11,15,25,.98), rgba(11,15,25,.92) 60%, transparent);
            backdrop-filter:saturate(1.1) blur(6px);
            border-bottom:1px solid rgba(38,48,67,.6);
        }
        .toolbar-wrap.fixed{ position:fixed; left:0; right:0; top:0; } /* JS fallback */
        #toolbar-spacer{height:0;} /* grows when fixed */

        .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px 16px;max-width:1200px;margin:0 auto}

        /* Unified buttons */
        .btn{
            display:inline-flex;align-items:center;justify-content:center;
            border:1px solid var(--ring);background:var(--card);color:var(--text);
            padding:8px 12px;border-radius:12px;cursor:pointer;
            transition:transform .06s ease,border-color .2s ease,background .2s ease;
            line-height:1; min-height:34px;
        }
        .btn:hover{border-color:var(--accent)}
        .btn:active{transform:translateY(1px)}
        .btn[disabled]{opacity:.45;cursor:not-allowed}

        /* Icon-only buttons */
        .btn.icon{width:38px; min-width:38px; height:34px; padding:0;}
        .btn.icon svg{width:18px;height:18px;display:block}

        input[type="search"]{
            border:1px solid var(--ring);background:var(--card);color:var(--text);
            padding:8px 12px;border-radius:12px;min-width:220px;height:34px
        }
        #status{font-size:13px;color:var(--muted)}
        .counter{margin-left:auto;font-weight:600;color:#a7f3d0;border:1px solid var(--ring);background:rgba(18,24,38,.6);padding:6px 10px;border-radius:10px}

        /* Layout: sidebar + content */
        .container{max-width:1200px;margin:12px auto;display:grid;grid-template-columns:260px 1fr;gap:16px;padding:0 16px}
        @media (max-width: 880px){
            .container{grid-template-columns:1fr}
            .sidebar{order:2}
        }
        .sidebar{background:var(--sidebar);border:1px solid var(--ring);border-radius:14px;padding:14px;position:sticky;top:84px;height:max-content}
        .side-title{font-size:14px;color:var(--muted);margin:0 0 8px}
        .filter{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--ring);border-radius:10px;background:rgba(18,24,38,.6);margin-bottom:8px;cursor:pointer}
        .filter:hover{border-color:var(--accent)}
        .filter input{width:14px;height:14px}
        .count-badge{margin-left:auto;font-size:12px;color:var(--muted);background:#0b1220;border:1px solid var(--ring);border-radius:8px;padding:2px 6px}

        /* Force 7 columns (with responsive fallback on small screens) */
        .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:14px}
        @media (max-width: 1200px){
            .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
        }

        .champ{position:relative;background:var(--card);border:1px solid var(--ring);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
        .imgwrap{width:100%;aspect-ratio:1/1;overflow:hidden;cursor:pointer}
        .imgwrap img{width:100%;height:100%;object-fit:cover;display:block;transition:filter .2s ease, opacity .2s ease}
        .name{padding:8px 10px 0;font-size:13px;color:var(--muted);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        /* Gray out when Won */
        .champ.status-won .imgwrap img{filter:grayscale(100%) contrast(90%) brightness(70%);opacity:.55}

        /* Status pill */
        .pill{position:absolute;top:6px;left:6px;display:flex;align-items:center;gap:6px}
        .tag{font-size:11px;line-height:1;padding:4px 6px;border-radius:7px;border:1px solid var(--ring);background:rgba(18,24,38,.7);color:var(--muted)}
        .tag[data-kind="won"]{color:#062e12;background:rgba(34,197,94,.9);border-color:#208a4a}
        .tag[data-kind="24"]{color:#2b2303;background:rgba(234,179,8,.92);border-color:#9a7a05}

        /* Options row */
        .options{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;align-items:center;padding:8px;border-top:1px solid var(--ring);background:linear-gradient(180deg, rgba(18,24,38,.6), rgba(18,24,38,.2))}
        .opt{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--ring);background:rgba(18,24,38,.7);border-radius:10px;font-size:12px;cursor:pointer;user-select:none}
        .opt:hover{border-color:var(--accent)}
        /* Hidden radio for a11y; visuals use .active class */
        .opt input{position:absolute;opacity:0;width:1px;height:1px;pointer-events:none;margin:0}
        .opt .box{width:14px;height:14px;border:1px solid var(--ring);border-radius:4px;display:inline-grid;place-items:center}
        .opt.active .box{border-color:var(--accent)}
        .opt.active .box::after{content:'✓';font-size:12px;line-height:1}

        .empty{color:var(--muted);text-align:center;padding:40px 10px}
        footer{padding:24px 0;color:var(--muted)}
    </style>
</head>
<body>
<div class="wrap titlebar">
    <h1>LoL Champions - Checklist</h1>
</div>

<!-- Sticky toolbar; spacer is used only for fixed fallback -->
<div class="toolbar-wrap" id="toolbar">
    <div class="toolbar">
        <input id="search" type="search" placeholder="Search champions…" aria-label="Search champions" />
        <button id="btnCheckAll" type="button" class="btn">Check all as Won</button>
        <button id="btnUncheckAll" type="button" class="btn">Clear all</button>

        <button id="btnExport" type="button" class="btn">Export</button>
        <label class="btn" for="fileImport">Import</label>
        <input id="fileImport" type="file" accept="application/json" hidden />

        <!-- Icon-only Undo / Redo placed to the right of Import -->
        <button id="btnUndo" type="button" class="btn icon" title="Undo (Ctrl/Cmd+Z)" aria-label="Undo" disabled>
            <!-- Undo icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M9 14l-5-5 5-5"/>
                <path d="M4 9h7a7 7 0 1 1 0 14h-1"/>
            </svg>
        </button>
        <button id="btnRedo" type="button" class="btn icon" title="Redo (Ctrl+Y or Ctrl/Cmd+Shift+Z)" aria-label="Redo" disabled>
            <!-- Redo icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M15 14l5-5-5-5"/>
                <path d="M20 9h-7a7 7 0 1 0 0 14h1"/>
            </svg>
        </button>

        <span id="status" role="status" aria-live="polite"></span>
        <span id="wonCounter" class="counter" title="Number of Won champions">Won: 0 / 0</span>
    </div>
</div>
<div id="toolbar-spacer"></div>

<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h3 class="side-title">Filters</h3>
        <label class="filter" id="flt-won">
            <input type="checkbox" />
            <span>Won</span>
            <span class="count-badge" id="count-won">0</span>
        </label>
        <label class="filter" id="flt-none">
            <input type="checkbox" />
            <span>Not won yet</span>
            <span class="count-badge" id="count-none">0</span>
        </label>
        <label class="filter" id="flt-24">
            <input type="checkbox" />
            <span>2–4 Place</span>
            <span class="count-badge" id="count-24">0</span>
        </label>
    </aside>

    <!-- Main -->
    <main>
        <div id="grid" class="grid" role="list" aria-label="Champions list"></div>
        <div id="empty" class="empty" hidden>No champions match your search.</div>
        <footer>
            <small>Data from Riot Data Dragon. Progress auto-saved locally. Export/import JSON to keep a file backup.</small>
        </footer>
    </main>
</div>

<script>
    const STORAGE_KEY = 'lol_champ_status_v14';
    const STATE = {
        version:null,
        champs:[],
        status:loadStatus(),              // { id: 'none'|'won'|'24' }
        filter:'',
        views:{won:false,none:false,p24:false},
        undo:[],                          // history stack (past states)
        redo:[]                           // future stack
    };

    // ---------- Persistence & notes ----------
    function loadStatus(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch{ return {}; } }
    function saveStatus(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE.status)); note('Saved'); }
    function note(msg){ const el=document.getElementById('status'); el.textContent=msg; clearTimeout(note._t); note._t=setTimeout(()=> el.textContent='', 1200); }

    // ---------- Sticky fallback ----------
    (function stickyFallback(){
        const tb = document.getElementById('toolbar');
        const spacer = document.getElementById('toolbar-spacer');
        if (!tb) return;
        const startTop = tb.offsetTop;
        function onScroll(){
            if (window.scrollY > startTop && tb.getBoundingClientRect().top < 0) {
                tb.classList.add('fixed');
                spacer.style.height = tb.offsetHeight + 'px';
            } else if (window.scrollY <= startTop) {
                tb.classList.remove('fixed');
                spacer.style.height = '0px';
            }
        }
        window.addEventListener('scroll', onScroll, { passive:true });
        window.addEventListener('resize', () => { if (tb.classList.contains('fixed')) spacer.style.height = tb.offsetHeight + 'px'; });
        onScroll();
    })();

    // ---------- Data Dragon ----------
    async function getLatestVersion(){
        const res = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
        if(!res.ok) throw new Error('Failed to get versions');
        return (await res.json())[0];
    }
    async function loadChampions(){
        const v = await getLatestVersion();
        STATE.version = v;
        const res = await fetch(`https://ddragon.leagueoflegends.com/cdn/${v}/data/en_US/champion.json`);
        if(!res.ok) throw new Error('Failed to load champions');
        const json = await res.json();
        STATE.champs = Object.values(json.data)
            .map(c => ({ id:c.id, name:c.name, image:c.image.full }))
            .sort((a,b)=> a.name.localeCompare(b.name));
    }
    function iconUrl(img){ return `https://ddragon.leagueoflegends.com/cdn/${STATE.version}/img/champion/${img}`; }

    // ---------- History (Undo / Redo) ----------
    const MAX_HISTORY = 200;
    function snapshot(obj){ return JSON.parse(JSON.stringify(obj)); }

    function pushHistory(prevStatus){
        STATE.undo.push(prevStatus);
        if (STATE.undo.length > MAX_HISTORY) STATE.undo.shift();
        STATE.redo = []; // clear redo on new action
        updateUndoRedoButtons();
    }
    function applyStatus(newStatus, silentNote){
        STATE.status = newStatus;
        saveStatus();
        if (silentNote) note(silentNote);
        render();
    }
    function undo(){
        if (!STATE.undo.length) return;
        const prev = STATE.undo.pop();
        STATE.redo.push(snapshot(STATE.status));
        applyStatus(prev, 'Undid');
        updateUndoRedoButtons();
    }
    function redo(){
        if (!STATE.redo.length) return;
        const next = STATE.redo.pop();
        STATE.undo.push(snapshot(STATE.status));
        applyStatus(next, 'Redid');
        updateUndoRedoButtons();
    }
    function updateUndoRedoButtons(){
        document.getElementById('btnUndo').disabled = STATE.undo.length === 0;
        document.getElementById('btnRedo').disabled = STATE.redo.length === 0;
    }

    // Wrap status-changing ops
    function changeSingle(id, val){
        const prev = snapshot(STATE.status);
        STATE.status[id] = val;
        pushHistory(prev);
        applyStatus(STATE.status);
    }
    function changeMany(ids, val){
        const prev = snapshot(STATE.status);
        for (const id of ids) STATE.status[id] = val;
        pushHistory(prev);
        applyStatus(STATE.status);
    }

    // ---------- Counts, filters, visibility ----------
    function getCounts(){
        let won=0, none=0, p24=0;
        for(const c of STATE.champs){
            const st=STATE.status[c.id]||'none';
            if(st==='won') won++; else if(st==='24') p24++; else none++;
        }
        return {won,none,p24,total:STATE.champs.length};
    }
    function passFilters(st){
        const {won,none,p24}=STATE.views;
        if(!won && !none && !p24) return true;
        if(won && st==='won') return true;
        if(none && st==='none') return true;
        if(p24 && st==='24') return true;
        return false;
    }
    function getVisibleChampionIds(){
        const q = STATE.filter.trim().toLowerCase();
        const itemsAll = q
            ? STATE.champs.filter(c => c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q))
            : STATE.champs;
        return itemsAll
            .filter(c => passFilters(STATE.status[c.id] || 'none'))
            .map(c => c.id);
    }

    // ---------- Render ----------
    function render(){
        const grid=document.getElementById('grid');
        const empty=document.getElementById('empty');
        grid.innerHTML='';

        const counts=getCounts();
        document.getElementById('wonCounter').textContent=`Won: ${counts.won} / ${counts.total}`;
        document.getElementById('count-won').textContent=counts.won;
        document.getElementById('count-none').textContent=counts.none;
        document.getElementById('count-24').textContent=counts.p24;

        const ids = getVisibleChampionIds();
        empty.hidden = ids.length !== 0;

        for (const id of ids){
            const champ = STATE.champs.find(x => x.id === id);
            const st = STATE.status[id] || 'none';

            const card=document.createElement('div');
            card.className='champ'+(st==='won'?' status-won':'');
            card.role='listitem';

            const imgwrap=document.createElement('div');
            imgwrap.className='imgwrap';
            const img=document.createElement('img');
            img.src=iconUrl(champ.image); img.alt=champ.name; img.loading='lazy';
            imgwrap.appendChild(img);
            // icon click: None ↔ Won
            imgwrap.addEventListener('click',()=>{
                const cur=STATE.status[id]||'none';
                changeSingle(id, cur==='won'?'none':'won');
            });

            const nm=document.createElement('div'); nm.className='name'; nm.textContent=champ.name;

            const pill=document.createElement('div'); pill.className='pill';
            if(st==='won'){const t=document.createElement('div'); t.className='tag'; t.dataset.kind='won'; t.textContent='Won'; pill.appendChild(t);}
            if(st==='24'){const t=document.createElement('div'); t.className='tag'; t.dataset.kind='24'; t.textContent='2–4 Place'; pill.appendChild(t);}

            const opts=document.createElement('div'); opts.className='options';
            opts.appendChild(makeOption('Won','won',id,st));
            opts.appendChild(makeOption('2–4 Place','24',id,st));

            card.appendChild(imgwrap); card.appendChild(nm); card.appendChild(pill); card.appendChild(opts);
            grid.appendChild(card);
        }

        updateUndoRedoButtons();
    }

    function makeOption(label,val,id,current){
        const wrap=document.createElement('label'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.name='opt-'+id;
        const box=document.createElement('span'); box.className='box';
        const text=document.createElement('span'); text.textContent=label;
        if(current===val){ wrap.classList.add('active'); input.checked=true; }
        wrap.appendChild(input); wrap.appendChild(box); wrap.appendChild(text);
        wrap.addEventListener('click',e=>{ e.preventDefault(); const cur=STATE.status[id]||'none'; changeSingle(id, cur===val?'none':val); });
        return wrap;
    }

    // ---------- UI wiring ----------
    function bindControls(){
        const search=document.getElementById('search');
        search.addEventListener('input',()=>{ STATE.filter=search.value; render(); });

        // Sidebar filters
        document.querySelector('#flt-won input').addEventListener('change',e=>{ STATE.views.won=e.target.checked; render(); });
        document.querySelector('#flt-none input').addEventListener('change',e=>{ STATE.views.none=e.target.checked; render(); });
        document.querySelector('#flt-24 input').addEventListener('change',e=>{ STATE.views.p24=e.target.checked; render(); });

        // Actions — only affect VISIBLE champs
        document.getElementById('btnCheckAll').addEventListener('click',()=>{
            changeMany(getVisibleChampionIds(), 'won');
        });
        document.getElementById('btnUncheckAll').addEventListener('click',()=>{
            changeMany(getVisibleChampionIds(), 'none');
        });

        // Undo / Redo
        document.getElementById('btnUndo').addEventListener('click', undo);
        document.getElementById('btnRedo').addEventListener('click', redo);

        document.getElementById('btnExport').addEventListener('click',()=>{
            const payload={version:STATE.version,status:STATE.status};
            const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
            a.download='lol-champions-progress.json'; a.click(); URL.revokeObjectURL(a.href);
        });

        document.getElementById('fileImport').addEventListener('change',async e=>{
            const file=e.target.files?.[0]; if(!file) return;
            try{
                const text=await file.text();
                const json=JSON.parse(text);
                if(json && typeof json==='object' && (json.status||json.checks)){
                    const prev = snapshot(STATE.status);
                    STATE.status=json.status||Object.fromEntries(Object.entries(json.checks).map(([k,v])=>[k, v?'won':'none']));
                    pushHistory(prev);
                    applyStatus(STATE.status, 'Imported');
                } else alert('Invalid file.');
            }catch(err){ alert('Failed to import: '+err.message); }
            finally{ e.target.value=''; }
        });

        // Global typing -> send to search input
        document.addEventListener('keypress', e => {
            const t = e.target.tagName;
            if (t === 'INPUT' || t === 'TEXTAREA' || e.metaKey || e.ctrlKey || e.altKey) return;
            search.focus();
            if (e.key.length === 1) {
                const start = search.selectionStart ?? search.value.length;
                const end = search.selectionEnd ?? search.value.length;
                search.setRangeText(e.key, start, end, 'end');
                search.dispatchEvent(new Event('input', { bubbles:true }));
            }
        });

        // Keyboard shortcuts: Undo/Redo
        document.addEventListener('keydown', (e) => {
            const z = e.key.toLowerCase() === 'z';
            const y = e.key.toLowerCase() === 'y';
            const meta = e.ctrlKey || e.metaKey;
            if (!meta) return;

            if (z && !e.shiftKey){ e.preventDefault(); undo(); }
            else if ((z && e.shiftKey) || y){ e.preventDefault(); redo(); }
        });
    }

    (async function(){
        try { bindControls(); await loadChampions(); render(); }
        catch(err){ document.getElementById('grid').innerHTML = `<div class="empty">Error: ${err.message}</div>`; console.error(err); }
    })();
</script>
</body>
</html>
